# Development Environment Ingress
# API ì„œë¸Œë„ë©”ì¸ íŒ¨í„´ ì‚¬ìš© (api.dev.krgeobuk.com)
# í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë¸Œë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¦¬

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-api-ingress
  namespace: krgeobuk-dev
  annotations:
    # NGINX Ingress Controller ì„¤ì •
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"

    # CORS ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ì„œë¸Œë„ë©”ì¸ í—ˆìš©)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "http://portal.192.168.0.28.nip.io, http://portal-admin.192.168.0.28.nip.io, http://mypick.192.168.0.28.nip.io, http://mypick-admin.192.168.0.28.nip.io"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # ìš”ì²­ í¬ê¸° ì œí•œ
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # SSL ë¦¬ë‹¤ì´ë ‰íŠ¸ (Dev í™˜ê²½ì€ ì„ íƒì )
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

    # cert-manager ì„¤ì • (ë„ë©”ì¸ ì¸ì¦ì„œ ìë™ ë°œê¸‰)
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì • (HTTPS ì‚¬ìš© ì‹œ í™œì„±í™”)
  # tls:
  # - hosts:
  #   - api.192.168.0.28.nip.io
  #   secretName: api-dev-krgeobuk-tls

  rules:
  # =============================================================================
  # API ì„œë¸Œë„ë©”ì¸: api.192.168.0.28.nip.io
  # ëª¨ë“  ë°±ì—”ë“œ API ì„œë¹„ìŠ¤ë¥¼ ê²½ë¡œë¡œ êµ¬ë¶„
  # =============================================================================
  - host: api.192.168.0.28.nip.io
    http:
      paths:
      # auth-server: /auth/*
      # ì˜ˆ: api.dev.krgeobuk.com/auth/login
      - path: /auth(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: auth-server
            port:
              number: 80

      # authz-server: /authz/*
      # ì˜ˆ: api.dev.krgeobuk.com/authz/permissions
      - path: /authz(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: authz-server
            port:
              number: 8100

      # portal-server: /portal/*
      # ì˜ˆ: api.dev.krgeobuk.com/portal/users
      - path: /portal(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: portal-server
            port:
              number: 8200

      # my-pick-server: /mypick/*
      # ì˜ˆ: api.dev.krgeobuk.com/mypick/items
      - path: /mypick(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: my-pick-server
            port:
              number: 8300

---
# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ìš© Ingress (ê°œë³„ ì„œë¸Œë„ë©”ì¸)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-portal-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - portal.192.168.0.28.nip.io
  #   secretName: portal-client-dev-tls

  rules:
  - host: portal.192.168.0.28.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-client
            port:
              number: 3200

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-admin-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - portal-admin.192.168.0.28.nip.io
  #   secretName: portal-admin-client-dev-tls

  rules:
  - host: portal-admin.192.168.0.28.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-admin-client
            port:
              number: 3210

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - mypick.192.168.0.28.nip.io
  #   secretName: mypick-client-dev-tls

  rules:
  - host: mypick.192.168.0.28.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-client
            port:
              number: 3300

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-admin-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - mypick-admin.192.168.0.28.nip.io
  #   secretName: mypick-admin-client-dev-tls

  rules:
  - host: mypick-admin.192.168.0.28.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-admin-client
            port:
              number: 3310

---
# =============================================================================
# Ingress ì‚¬ìš© ê°€ì´ë“œ
# =============================================================================
#
# ğŸ“‹ ë„ë©”ì¸ êµ¬ì¡° (nip.io ì‚¬ìš©):
# ---------------
# miniPC IP: 192.168.0.28
# nip.io: ë¬´ë£Œ wildcard DNS ì„œë¹„ìŠ¤ (IPë¥¼ ë„ë©”ì¸ì²˜ëŸ¼ ì‚¬ìš©)
#
# í´ë¼ì´ì–¸íŠ¸ (ì„œë¸Œë„ë©”ì¸):
#   - portal.192.168.0.28.nip.io       â†’ portal-client (Next.js)
#   - portal-admin.192.168.0.28.nip.io â†’ portal-admin-client (Next.js)
#   - mypick.192.168.0.28.nip.io       â†’ my-pick-client (Next.js)
#   - mypick-admin.192.168.0.28.nip.io â†’ my-pick-admin-client (Next.js)
#
# API (api ì„œë¸Œë„ë©”ì¸ + ê²½ë¡œ):
#   - api.192.168.0.28.nip.io/auth/*   â†’ auth-server (NestJS)
#   - api.192.168.0.28.nip.io/authz/*  â†’ authz-server (NestJS)
#   - api.192.168.0.28.nip.io/portal/* â†’ portal-server (NestJS)
#   - api.192.168.0.28.nip.io/mypick/* â†’ my-pick-server (NestJS)
#
# ğŸ“ API í˜¸ì¶œ ì˜ˆì‹œ:
# -----------------
# // portal-clientì—ì„œ API í˜¸ì¶œ
# const response = await fetch('http://api.192.168.0.28.nip.io/auth/login', {
#   method: 'POST',
#   credentials: 'include',
#   headers: { 'Content-Type': 'application/json' },
#   body: JSON.stringify({ username, password })
# });
#
# // Next.js ìì²´ API (í—¬ìŠ¤ì²´í¬)
# // pages/api/health.ts â†’ http://portal.192.168.0.28.nip.io/api/health
# export default function handler(req, res) {
#   res.status(200).json({ status: 'ok' })
# }
#
# ğŸ”’ HTTPS/TLS ì„¤ì •:
# ------------------
# 1. cert-manager ì„¤ì¹˜:
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. ClusterIssuer ìƒì„±:
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: letsencrypt-staging
#    spec:
#      acme:
#        server: https://acme-staging-v02.api.letsencrypt.org/directory
#        email: your-email@example.com
#        privateKeySecretRef:
#          name: letsencrypt-staging
#        solvers:
#        - http01:
#            ingress:
#              class: nginx
#
# 3. Ingressì˜ tls ì„¹ì…˜ê³¼ cert-manager annotation ì£¼ì„ í•´ì œ
#
# ğŸŒ nip.io ì‚¬ìš© (DNS ì„¤ì • ë¶ˆí•„ìš”):
# ------------
# nip.ioëŠ” ìë™ìœ¼ë¡œ DNSë¥¼ í•´ì„í•´ì£¼ë¯€ë¡œ ë³„ë„ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤!
#
# ì‘ë™ ë°©ì‹:
#   portal.192.168.0.28.nip.io â†’ ìë™ìœ¼ë¡œ 192.168.0.28ë¡œ í•´ì„
#   api.192.168.0.28.nip.io    â†’ ìë™ìœ¼ë¡œ 192.168.0.28ë¡œ í•´ì„
#
# ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥:
#   http://portal.192.168.0.28.nip.io
#   http://api.192.168.0.28.nip.io/auth/login
#
# ê°™ì€ ë„¤íŠ¸ì›Œí¬ì˜ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥:
#   - ìŠ¤ë§ˆíŠ¸í°
#   - ë‹¤ë¥¸ PC
#   - íƒœë¸”ë¦¿
#
# ğŸ”„ ë‚˜ì¤‘ì— ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ì „í™˜:
# ----------------------------
# ë„ë©”ì¸ êµ¬ì… í›„ hostë§Œ ë³€ê²½í•˜ë©´ ë©ë‹ˆë‹¤:
#   api.192.168.0.28.nip.io â†’ api.dev.krgeobuk.com
#   portal.192.168.0.28.nip.io â†’ portal.dev.krgeobuk.com
#
# ğŸ“¦ ë°°í¬:
# --------
# kubectl apply -f environments/dev/ingress.yaml
#
# ğŸ” í™•ì¸:
# --------
# kubectl get ingress -n krgeobuk-dev
# kubectl describe ingress krgeobuk-api-ingress -n krgeobuk-dev
#
# ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…:
# --------------
# # Ingress Controller ë¡œê·¸
# kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
#
# # íŠ¹ì • Ingress ì´ë²¤íŠ¸
# kubectl get events -n krgeobuk-dev --sort-by='.lastTimestamp'
