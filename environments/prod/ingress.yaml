# Production Environment Ingress
# API ì„œë¸Œë„ë©”ì¸ íŒ¨í„´ ì‚¬ìš© (api.krgeobuk.com)
# í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë¸Œë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¦¬
# TLS/HTTPS í•„ìˆ˜

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-api-ingress
  namespace: krgeobuk-prod
  annotations:
    # NGINX Ingress Controller ì„¤ì •
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"

    # CORS ì„¤ì • (í”„ë¡œë•ì…˜ - í´ë¼ì´ì–¸íŠ¸ ì„œë¸Œë„ë©”ì¸ í—ˆìš©)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://portal.krgeobuk.com, https://portal-admin.krgeobuk.com, https://mypick.krgeobuk.com, https://mypick-admin.krgeobuk.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # ìš”ì²­ í¬ê¸° ì œí•œ
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # SSL ë¦¬ë‹¤ì´ë ‰íŠ¸ í™œì„±í™” (Prod í™˜ê²½ í•„ìˆ˜)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # HSTS ì„¤ì • (ë³´ì•ˆ ê°•í™”)
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"

    # Rate Limiting (ì„ íƒì‚¬í•­)
    # nginx.ingress.kubernetes.io/limit-rps: "100"

    # cert-manager ì„¤ì • (ìë™ SSL ì¸ì¦ì„œ ë°œê¸‰)
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì • (Let's Encrypt ìë™ ì¸ì¦ì„œ)
  tls:
  - hosts:
    - api.krgeobuk.com
    secretName: api-krgeobuk-tls

  rules:
  # =============================================================================
  # API ì„œë¸Œë„ë©”ì¸: api.krgeobuk.com
  # ëª¨ë“  ë°±ì—”ë“œ API ì„œë¹„ìŠ¤ë¥¼ ê²½ë¡œë¡œ êµ¬ë¶„
  # =============================================================================
  - host: api.krgeobuk.com
    http:
      paths:
      # auth-server: /auth/*
      # ì˜ˆ: api.krgeobuk.com/auth/login
      - path: /auth(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: auth-server
            port:
              number: 80

      # authz-server: /authz/*
      # ì˜ˆ: api.krgeobuk.com/authz/permissions
      - path: /authz(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: authz-server
            port:
              number: 8100

      # portal-server: /portal/*
      # ì˜ˆ: api.krgeobuk.com/portal/users
      - path: /portal(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: portal-server
            port:
              number: 8200

      # my-pick-server: /mypick/*
      # ì˜ˆ: api.krgeobuk.com/mypick/items
      - path: /mypick(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: my-pick-server
            port:
              number: 8300

---
# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ìš© Ingress (ê°œë³„ ì„œë¸Œë„ë©”ì¸)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-portal-client-ingress
  namespace: krgeobuk-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  tls:
  - hosts:
    - portal.krgeobuk.com
    secretName: portal-client-tls

  rules:
  - host: portal.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-client
            port:
              number: 3200

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-admin-client-ingress
  namespace: krgeobuk-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  tls:
  - hosts:
    - portal-admin.krgeobuk.com
    secretName: portal-admin-client-tls

  rules:
  - host: portal-admin.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-admin-client
            port:
              number: 3210

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-client-ingress
  namespace: krgeobuk-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  tls:
  - hosts:
    - mypick.krgeobuk.com
    secretName: mypick-client-tls

  rules:
  - host: mypick.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-client
            port:
              number: 3300

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-admin-client-ingress
  namespace: krgeobuk-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  tls:
  - hosts:
    - mypick-admin.krgeobuk.com
    secretName: mypick-admin-client-tls

  rules:
  - host: mypick-admin.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-admin-client
            port:
              number: 3310

---
# =============================================================================
# Ingress ì‚¬ìš© ê°€ì´ë“œ (Production)
# =============================================================================
#
# ğŸ“‹ ë„ë©”ì¸ êµ¬ì¡°:
# ---------------
# ì˜ˆì‹œ ë„ë©”ì¸: krgeobuk.com (ì‹¤ì œ ë°°í¬ ì‹œ ë„ë©”ì¸ ë³€ê²½ í•„ìš”)
#
# í´ë¼ì´ì–¸íŠ¸ (ì„œë¸Œë„ë©”ì¸):
#   - portal.krgeobuk.com       â†’ portal-client (Next.js)
#   - portal-admin.krgeobuk.com â†’ portal-admin-client (Next.js)
#   - mypick.krgeobuk.com       â†’ my-pick-client (Next.js)
#   - mypick-admin.krgeobuk.com â†’ my-pick-admin-client (Next.js)
#
# API (api ì„œë¸Œë„ë©”ì¸ + ê²½ë¡œ):
#   - api.krgeobuk.com/auth/*   â†’ auth-server (NestJS)
#   - api.krgeobuk.com/authz/*  â†’ authz-server (NestJS)
#   - api.krgeobuk.com/portal/* â†’ portal-server (NestJS)
#   - api.krgeobuk.com/mypick/* â†’ my-pick-server (NestJS)
#
# ğŸ“ API í˜¸ì¶œ ì˜ˆì‹œ:
# -----------------
# // portal-clientì—ì„œ API í˜¸ì¶œ
# const response = await fetch('https://api.krgeobuk.com/auth/login', {
#   method: 'POST',
#   credentials: 'include',
#   headers: { 'Content-Type': 'application/json' },
#   body: JSON.stringify({ username, password })
# });
#
# // Next.js ìì²´ API (í—¬ìŠ¤ì²´í¬)
# // pages/api/health.ts â†’ https://portal.krgeobuk.com/api/health
# export default function handler(req, res) {
#   res.status(200).json({ status: 'ok' })
# }
#
# ğŸ”’ HTTPS/TLS ìë™ ì„¤ì • (cert-manager):
# --------------------------------------
# 1. cert-manager ì„¤ì¹˜ (í´ëŸ¬ìŠ¤í„°ì— í•œ ë²ˆë§Œ):
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. Let's Encrypt ClusterIssuer ìƒì„±:
#
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: letsencrypt-prod
#    spec:
#      acme:
#        server: https://acme-v02.api.letsencrypt.org/directory
#        email: your-email@example.com  # ì‹¤ì œ ì´ë©”ì¼ë¡œ ë³€ê²½ í•„ìš”
#        privateKeySecretRef:
#          name: letsencrypt-prod
#        solvers:
#        - http01:
#            ingress:
#              class: nginx
#
# 3. Ingress ë°°í¬ ì‹œ ìë™ìœ¼ë¡œ SSL ì¸ì¦ì„œ ë°œê¸‰ë¨
#
# ğŸ“Œ ë°°í¬ ì „ í•„ìˆ˜ ì„¤ì •:
# ---------------------
# 1. ë„ë©”ì¸ ë³€ê²½:
#    - ëª¨ë“  *.krgeobuk.comì„ ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½
#    - CORS ì„¤ì •ì˜ originë„ í•¨ê»˜ ë³€ê²½
#
# 2. DNS ì„¤ì •:
#    - Ingress Controllerì˜ External IP í™•ì¸:
#      kubectl get svc -n ingress-nginx ingress-nginx-controller
#
#    - DNS A ë ˆì½”ë“œ ì¶”ê°€:
#      api.krgeobuk.com         â†’ <EXTERNAL-IP>
#      portal.krgeobuk.com      â†’ <EXTERNAL-IP>
#      portal-admin.krgeobuk.com â†’ <EXTERNAL-IP>
#      mypick.krgeobuk.com      â†’ <EXTERNAL-IP>
#      mypick-admin.krgeobuk.com â†’ <EXTERNAL-IP>
#
# 3. cert-manager ClusterIssuer ì´ë©”ì¼ ì„¤ì •:
#    - letsencrypt-prodì˜ emailì„ ì‹¤ì œ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë³€ê²½
#
# ğŸ“¦ ë°°í¬:
# --------
# kubectl apply -f environments/prod/ingress.yaml
#
# ğŸ” í™•ì¸:
# --------
# # Ingress ëª©ë¡
# kubectl get ingress -n krgeobuk-prod
#
# # TLS ì¸ì¦ì„œ í™•ì¸
# kubectl get certificate -n krgeobuk-prod
#
# # ì¸ì¦ì„œ ìƒì„¸ ì •ë³´
# kubectl describe certificate api-krgeobuk-tls -n krgeobuk-prod
#
# # ì¸ì¦ì„œ ë°œê¸‰ ê³¼ì • í™•ì¸
# kubectl get certificaterequest -n krgeobuk-prod
#
# ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…:
# --------------
# # Ingress Controller ë¡œê·¸
# kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
#
# # cert-manager ë¡œê·¸
# kubectl logs -n cert-manager -l app=cert-manager
#
# # íŠ¹ì • Ingress ì´ë²¤íŠ¸
# kubectl get events -n krgeobuk-prod --sort-by='.lastTimestamp'
#
# # ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨ ì‹œ
# kubectl describe challenge -n krgeobuk-prod
#
# ğŸ” ë³´ì•ˆ ì„¤ì •:
# -------------
# - SSL/TLS: Let's Encrypt ìë™ ì¸ì¦ì„œ
# - HSTS: 31536000ì´ˆ (1ë…„), ì„œë¸Œë„ë©”ì¸ í¬í•¨
# - Force HTTPS: ëª¨ë“  HTTP ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
# - CORS: íŠ¹ì • ì„œë¸Œë„ë©”ì¸ë§Œ í—ˆìš© (credentials í¬í•¨)
# - Rate Limiting: í•„ìš” ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ ì‚¬ìš©
#
# ğŸ’¡ íŒ:
# ------
# - í”„ë¡œë•ì…˜ ë°°í¬ ì „ staging í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ê¶Œì¥
# - letsencrypt-stagingìœ¼ë¡œ ë¨¼ì € í…ŒìŠ¤íŠ¸ í›„ letsencrypt-prod ì‚¬ìš©
# - DNS ì „íŒŒëŠ” ìµœëŒ€ 48ì‹œê°„ ì†Œìš”ë  ìˆ˜ ìˆìŒ (ë³´í†µ ëª‡ ë¶„ ~ ëª‡ ì‹œê°„)
# - Let's EncryptëŠ” ë„ë©”ì¸ë‹¹ ì£¼ê°„ ë°œê¸‰ ì œí•œì´ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜
