# Development Environment Ingress
# API ì„œë¸Œë„ë©”ì¸ íŒ¨í„´ ì‚¬ìš© (api.dev.krgeobuk.com)
# í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë¸Œë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¦¬

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-api-ingress
  namespace: krgeobuk-dev
  annotations:
    # NGINX Ingress Controller ì„¤ì •
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"

    # CORS ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ì„œë¸Œë„ë©”ì¸ í—ˆìš©)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://portal.dev.krgeobuk.com, https://admin.dev.krgeobuk.com, https://mypick.dev.krgeobuk.com, https://mypick-admin.dev.krgeobuk.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # ìš”ì²­ í¬ê¸° ì œí•œ
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # SSL ë¦¬ë‹¤ì´ë ‰íŠ¸ (Dev í™˜ê²½ì€ ì„ íƒì )
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

    # cert-manager ì„¤ì • (ë„ë©”ì¸ ì¸ì¦ì„œ ìë™ ë°œê¸‰)
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì • (HTTPS ì‚¬ìš© ì‹œ í™œì„±í™”)
  # tls:
  # - hosts:
  #   - api.dev.krgeobuk.com
  #   secretName: api-dev-krgeobuk-tls

  rules:
  # =============================================================================
  # API ì„œë¸Œë„ë©”ì¸: api.dev.krgeobuk.com
  # ëª¨ë“  ë°±ì—”ë“œ API ì„œë¹„ìŠ¤ë¥¼ ê²½ë¡œë¡œ êµ¬ë¶„
  # =============================================================================
  - host: api.dev.krgeobuk.com
    http:
      paths:
      # auth-server: /auth/*
      # ì˜ˆ: api.dev.krgeobuk.com/auth/login
      - path: /auth(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: auth-server
            port:
              number: 80

      # authz-server: /authz/*
      # ì˜ˆ: api.dev.krgeobuk.com/authz/permissions
      - path: /authz(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: authz-server
            port:
              number: 8100

      # portal-server: /portal/*
      # ì˜ˆ: api.dev.krgeobuk.com/portal/users
      - path: /portal(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: portal-server
            port:
              number: 8200

      # my-pick-server: /mypick/*
      # ì˜ˆ: api.dev.krgeobuk.com/mypick/items
      - path: /mypick(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: my-pick-server
            port:
              number: 8300

---
# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ìš© Ingress (ê°œë³„ ì„œë¸Œë„ë©”ì¸)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-portal-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - portal.dev.krgeobuk.com
  #   secretName: portal-client-dev-tls

  rules:
  - host: portal.dev.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-client
            port:
              number: 3200

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-admin-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - admin.dev.krgeobuk.com
  #   secretName: portal-admin-client-dev-tls

  rules:
  - host: admin.dev.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: portal-admin-client
            port:
              number: 3210

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - mypick.dev.krgeobuk.com
  #   secretName: mypick-client-dev-tls

  rules:
  - host: mypick.dev.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-client
            port:
              number: 3300

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: krgeobuk-mypick-admin-client-ingress
  namespace: krgeobuk-dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-staging"

spec:
  ingressClassName: nginx

  # TLS ì„¤ì •
  # tls:
  # - hosts:
  #   - mypick-admin.dev.krgeobuk.com
  #   secretName: mypick-admin-client-dev-tls

  rules:
  - host: mypick-admin.dev.krgeobuk.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-pick-admin-client
            port:
              number: 3310

---
# =============================================================================
# Ingress ì‚¬ìš© ê°€ì´ë“œ
# =============================================================================
#
# ğŸ“‹ ë„ë©”ì¸ êµ¬ì¡°:
# ---------------
# í´ë¼ì´ì–¸íŠ¸ (ì„œë¸Œë„ë©”ì¸):
#   - portal.dev.krgeobuk.com       â†’ portal-client (Next.js)
#   - admin.dev.krgeobuk.com        â†’ portal-admin-client (Next.js)
#   - mypick.dev.krgeobuk.com       â†’ my-pick-client (Next.js)
#   - mypick-admin.dev.krgeobuk.com â†’ my-pick-admin-client (Next.js)
#
# API (api ì„œë¸Œë„ë©”ì¸ + ê²½ë¡œ):
#   - api.dev.krgeobuk.com/auth/*   â†’ auth-server (NestJS)
#   - api.dev.krgeobuk.com/authz/*  â†’ authz-server (NestJS)
#   - api.dev.krgeobuk.com/portal/* â†’ portal-server (NestJS)
#   - api.dev.krgeobuk.com/mypick/* â†’ my-pick-server (NestJS)
#
# ğŸ“ API í˜¸ì¶œ ì˜ˆì‹œ:
# -----------------
# // portal-clientì—ì„œ API í˜¸ì¶œ
# const response = await fetch('https://api.dev.krgeobuk.com/auth/login', {
#   method: 'POST',
#   credentials: 'include',
#   headers: { 'Content-Type': 'application/json' },
#   body: JSON.stringify({ username, password })
# });
#
# // Next.js ìì²´ API (í—¬ìŠ¤ì²´í¬)
# // pages/api/health.ts â†’ https://portal.dev.krgeobuk.com/api/health
# export default function handler(req, res) {
#   res.status(200).json({ status: 'ok' })
# }
#
# ğŸ”’ HTTPS/TLS ì„¤ì •:
# ------------------
# 1. cert-manager ì„¤ì¹˜:
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. ClusterIssuer ìƒì„±:
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: letsencrypt-staging
#    spec:
#      acme:
#        server: https://acme-staging-v02.api.letsencrypt.org/directory
#        email: your-email@example.com
#        privateKeySecretRef:
#          name: letsencrypt-staging
#        solvers:
#        - http01:
#            ingress:
#              class: nginx
#
# 3. Ingressì˜ tls ì„¹ì…˜ê³¼ cert-manager annotation ì£¼ì„ í•´ì œ
#
# ğŸŒ DNS ì„¤ì •:
# ------------
# dev.krgeobuk.comì˜ DNSì— ë‹¤ìŒ ë ˆì½”ë“œ ì¶”ê°€:
#
# A ë ˆì½”ë“œ:
#   dev.krgeobuk.com           â†’ <Ingress Controller IP>
#
# CNAME ë ˆì½”ë“œ (ë˜ëŠ” A ë ˆì½”ë“œ):
#   api.dev.krgeobuk.com       â†’ dev.krgeobuk.com (ë˜ëŠ” ê°™ì€ IP)
#   portal.dev.krgeobuk.com    â†’ dev.krgeobuk.com (ë˜ëŠ” ê°™ì€ IP)
#   admin.dev.krgeobuk.com     â†’ dev.krgeobuk.com (ë˜ëŠ” ê°™ì€ IP)
#   mypick.dev.krgeobuk.com    â†’ dev.krgeobuk.com (ë˜ëŠ” ê°™ì€ IP)
#   mypick-admin.dev.krgeobuk.com â†’ dev.krgeobuk.com (ë˜ëŠ” ê°™ì€ IP)
#
# ë˜ëŠ” Wildcard:
#   *.dev.krgeobuk.com         â†’ <Ingress Controller IP>
#
# ğŸ§ª ë¡œì»¬ í…ŒìŠ¤íŠ¸ (/etc/hosts):
# ----------------------------
# # Windows: C:\Windows\System32\drivers\etc\hosts
# # Linux/Mac: /etc/hosts
#
# 192.168.1.100 api.dev.krgeobuk.com
# 192.168.1.100 portal.dev.krgeobuk.com
# 192.168.1.100 admin.dev.krgeobuk.com
# 192.168.1.100 mypick.dev.krgeobuk.com
# 192.168.1.100 mypick-admin.dev.krgeobuk.com
#
# ğŸ“¦ ë°°í¬:
# --------
# kubectl apply -f environments/dev/ingress.yaml
#
# ğŸ” í™•ì¸:
# --------
# kubectl get ingress -n krgeobuk-dev
# kubectl describe ingress krgeobuk-api-ingress -n krgeobuk-dev
#
# ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…:
# --------------
# # Ingress Controller ë¡œê·¸
# kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
#
# # íŠ¹ì • Ingress ì´ë²¤íŠ¸
# kubectl get events -n krgeobuk-dev --sort-by='.lastTimestamp'
