apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: krgeobuk-prod

resources:
- ../../base
- ../../applications/auth-server
- ../../applications/auth-client
- ../../applications/authz-server
- ../../applications/portal-client

patches:
- path: patches/auth-server-prod.yaml
- path: patches/auth-client-prod.yaml
- path: patches/authz-server-prod.yaml
- path: patches/portal-client-prod.yaml

configMapGenerator:
# ========================================
# auth-server 운영 환경 설정
# ========================================
- name: auth-server-config
  behavior: merge
  literals:
  # 환경 설정
  - NODE_ENV=production

  # MySQL 설정 (운영 DB)
  - MYSQL_DATABASE=auth_prod

  # CORS 설정 (운영 환경 URL)
  - CORS_ORIGINS=https://auth.krgeobuk.com,https://portal.krgeobuk.com,https://admin.krgeobuk.com
  - ALLOWED_REDIRECT_DOMAINS=krgeobuk.com,auth.krgeobuk.com,portal.krgeobuk.com,admin.krgeobuk.com
  - ALLOWED_REDIRECT_PROTOCOLS=https

  # 클라이언트 URL (운영 도메인)
  - AUTH_CLIENT_URL=https://auth.krgeobuk.com
  - PORTAL_CLIENT_URL=https://portal.krgeobuk.com

  # OAuth 리다이렉트 URL (운영 환경)
  - GOOGLE_REDIRECT_URL=https://auth.krgeobuk.com/api/oauth/login-google/callback
  - NAVER_REDIRECT_URL=https://auth.krgeobuk.com/api/oauth/login-naver/callback

  # JWT 쿠키 도메인
  - JWT_COOKIE_DOMAIN=.krgeobuk.com

  # Email 인증 Base URL
  - EMAIL_VERIFICATION_BASE_URL=https://auth.krgeobuk.com

# ========================================
# auth-client 운영 환경 설정
# ========================================
- name: auth-client-config
  behavior: merge
  literals:
  # 환경 설정
  - NODE_ENV=production
  - NEXT_PUBLIC_ENVIRONMENT=production

  # 서버 URL (Kubernetes Service 이름)
  - NEXT_PUBLIC_AUTH_SERVER_URL=http://auth-server/api

  # SSO 도메인
  - NEXT_PUBLIC_DOMAIN=krgeobuk.com

  # 앱 URL (운영 도메인)
  - NEXT_PUBLIC_APP_URL=https://auth.krgeobuk.com
  - NEXT_PUBLIC_PORTAL_CLIENT_URL=https://portal.krgeobuk.com
  - NEXT_PUBLIC_PORTAL_ADMIN_URL=https://admin.krgeobuk.com

  # 허용된 도메인
  # - ALLOWED_ORIGINS=krgeobuk.com,auth.krgeobuk.com,portal.krgeobuk.com,admin.krgeobuk.com

# ========================================
# authz-server 운영 환경 설정
# ========================================
- name: authz-server-config
  behavior: merge
  literals:
  # 환경 설정
  - NODE_ENV=production

  # MySQL 설정 (운영 DB)
  - MYSQL_DATABASE=authz_prod

  # CORS 설정 (운영 환경 URL)
  - CORS_ORIGINS=https://auth.krgeobuk.com,https://portal.krgeobuk.com,https://admin.krgeobuk.com

  # 로깅 (운영 환경은 info)
  - LOG_LEVEL=info

  # 성능 튜닝 (운영 환경은 긴 TTL)
  - PERMISSION_CACHE_TTL=600

# ========================================
# portal-client 운영 환경 설정
# ========================================
- name: portal-client-config
  behavior: merge
  literals:
  # 환경 설정
  - NODE_ENV=production
  - NEXT_PUBLIC_ENVIRONMENT=production

  # 서버 URL (Kubernetes Service 이름)
  - NEXT_PUBLIC_AUTH_SERVER_URL=http://auth-server/api
  - NEXT_PUBLIC_AUTHZ_SERVER_URL=http://authz-server/api
  - NEXT_PUBLIC_PORTAL_SERVER_URL=http://portal-server/api
  - NEXT_PUBLIC_TOKEN_REFRESH_URL=http://auth-server/api/auth/refresh
  - NEXT_PUBLIC_PORTAL_CLIENT_URL=https://portal.krgeobuk.com

  # 디버그 설정 (운영 환경은 비활성화)
  - NEXT_PUBLIC_DEBUG=false
  - NEXT_PUBLIC_LOG_LEVEL=error

  # 보안 설정 (운영 환경은 엄격)
  - NEXT_PUBLIC_RATE_LIMIT_MAX_ATTEMPTS=30
  - ALLOWED_ORIGINS=krgeobuk.com,auth.krgeobuk.com,authz.krgeobuk.com,portal.krgeobuk.com

commonLabels:
  environment: production
